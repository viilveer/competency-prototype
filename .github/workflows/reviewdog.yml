name: Code style (PSR12)
on: [pull_request]
jobs:
  phpcs:
    name: PHP CodeSniffer
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP Action
        # You may pin to the exact commit or the version.
        # uses: shivammathur/setup-php@c596331f84de248c01c26db5a184880781e96e36
        uses: shivammathur/setup-php@2.7.0
        with:
          php-version: "7.4"
          tools: phpcs
      - name: Fetch base branch
        id: base_branch
        run: |
          git fetch --progress origin ${{ github.base_ref }}
      - name: And finally, diff
        id: files
        run: echo '::set-output name=diff::(git diff --name-only origin/${{ github.base_ref }} | xargs)'
      - name: Setup reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /usr/local/bin/
      - name: Run PHP Code Sniffer on added and modified files
        run: 
          phpcs --report=json --standard=phpcs.xml ${{ steps.files.outputs.diff }} | jq -r ' .files | to_entries[] | .key as $path | .value.messages[] as $msg | "\($path):\($msg.line):\($msg.column):`\($msg.source)`<br>\($msg.message)" ' | reviewdog -tee -efm="%f:%l:%c:%m" -reporter=github-pr-review -filter-mode="added" -fail-on-error=false -level="warning"
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
